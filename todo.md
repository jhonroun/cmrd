# План реализации CMRD (переписывание Cloud Mail Downloader на Go)

## Текущий прогресс
- [x] Каркас проекта (CLI/TUI/gRPC/library) создан и собирается.
- [x] Базовая логика резолва ссылок Cloud.Mail перенесена в Go.
- [x] Интеграция aria2c через env `CMRD_ARIA2C_PATH` реализована.
- [x] Базовый gRPC API реализован, включая stream `SubscribeProgress`.
- [x] README и документация RU/EN добавлены с quick start и first run.
- [x] Базовые тесты и CI/линт-конфиг добавлены.
- [ ] Расширить покрытие тестами сетевой логики с mock HTTP Cloud.Mail API.
- [ ] Добавить дополнительные команды/SDK-примеры для внешних gRPC клиентов.

## 1. Базовая архитектура и структура репозитория
- Цель: создать чистую и расширяемую архитектуру для CLI/TUI, gRPC и библиотечного использования.
- Действия:
  - создать структуру `cmd/`, `pkg/`, `internal/`, `api/proto/`, `doc/`;
  - выделить доменные сущности (ссылка, файл, задача скачивания, прогресс);
  - выделить интерфейсы для CloudMail API-клиента, резолвера ссылок, менеджера загрузок, хранилища состояния.
- Результат:
  - каркас проекта компилируется;
  - публичный API находится в `pkg/cmrd`.

## 2. Портирование логики из reference/cloud_mail_downloader.php
- Цель: полностью перенести функционал обхода публичных ссылок Cloud.Mail и подготовки задач на скачивание.
- Действия:
  - реализовать чтение входных ссылок (файл/параметры CLI/API);
  - реализовать получение `pageId` из HTML;
  - реализовать запросы к `dispatcher` и `folder` API;
  - реализовать рекурсивный обход папок с поддержкой вложенности;
  - реализовать очистку некорректных для Windows символов в путях;
  - реализовать формирование конечных URL и назначения выходных путей.
- Результат:
  - для тестовых ссылок формируется корректный список файлов для скачивания.

## 3. Интеграция aria2c (Windows/Linux, через env)
- Цель: запуск загрузки через внешнюю `aria2c`, путь берется из переменных окружения.
- Действия:
  - поддержать env-переменную пути к бинарнику (`CMRD_ARIA2C_PATH`, с fallback на `aria2c` из `PATH`);
  - реализовать генерацию input-файла для aria2c;
  - реализовать запуск aria2c с параметрами конкурентной загрузки и докачки;
  - добавить обработку ошибок запуска/завершения процесса;
  - добавить совместимость с Windows/Linux (пути, shell-free запуск через `exec.Command`).
- Результат:
  - загрузка стартует и завершаетcя в обеих ОС при наличии aria2c.

## 4. Режим CLI
- Цель: сделать полноценный консольный интерфейс.
- Действия:
  - добавить команды: `download`, `resolve`, `serve grpc`, `version`, `help`;
  - добавить ключи: входные ссылки, папка назначения, прокси, параллелизм, логирование;
  - обеспечить `--help` у приложения и у каждой команды.
- Результат:
  - CLI покрывает все основные сценарии без TUI.

## 5. Режим TUI (Bubble Tea)
- Цель: интерактивный обновляемый экран, без перезаписи блоков вывода.
- Действия:
  - реализовать модель состояния загрузки (очередь, активные задачи, скорость, прогресс);
  - добавить периодическое обновление состояния (tick/update);
  - отрисовать прогресс-бары, статусы и журнал событий;
  - добавить горячие клавиши (выход, пауза, справка).
- Результат:
  - TUI обновляет экран в реальном времени и показывает прогресс загрузки.

## 6. gRPC интерфейс
- Цель: дать транспорт для WEB UI и внешних GUI-клиентов.
- Действия:
  - описать API в `api/proto/cmrd/v1/*.proto`;
  - добавить методы: `ResolveLinks`, `StartDownload`, `GetProgress`, `StopJob`, `ListJobs`;
  - реализовать gRPC сервер;
  - добавить health-check и reflection.
- Результат:
  - внешний клиент может запускать и контролировать задачи через gRPC.

## 7. Режим библиотеки
- Цель: возможность использовать проект как Go-библиотеку.
- Действия:
  - спроектировать публичный пакет `pkg/cmrd`;
  - предоставить стабильные API-методы и типы конфигурации;
  - отделить transport/UI от бизнес-логики.
- Результат:
  - сторонний Go-проект может импортировать `github.com/jhonroun/cmrd/pkg/cmrd` и запускать задачи программно.

## 8. Документация (RU/EN)
- Цель: полноценная документация в `doc` и корневом README.
- Действия:
  - создать `doc/ru/` и `doc/en/`;
  - подготовить руководства: установка, конфигурация, quick start, first run, CLI, TUI, gRPC, library usage;
  - обновить корневой `README.md`: ссылки на RU/EN документы, summary + quick start + first run на обоих языках.
- Результат:
  - документация покрывает запуск и интеграцию для пользователя и разработчика.

## 9. Лицензирование
- Цель: корректно унаследовать тип лицензии от aria2c.
- Действия:
  - проверить лицензию aria2c;
  - оформить `LICENSE` и секцию лицензии в документации;
  - добавить атрибуцию сторонних компонентов.
- Результат:
  - в проекте явно определены лицензия и зависимости.

## 10. Качество и процессы
- Цель: обеспечить стабильность и сопровождаемость.
- Действия:
  - написать unit-тесты на критичную бизнес-логику;
  - добавить линтер и минимальный CI;
  - поддерживать атомарные коммиты: одна фича — один коммит;
  - вести `changelog.md` по формату `mm.dd.yyyy hh:mm`.
- Результат:
  - проект проходит тесты и линтер, изменения отслеживаются прозрачно.

## Критерии готовности первой итерации (MVP)
- Рабочий CLI для `resolve` и `download`.
- Базовый TUI с обновляемым экраном и прогрессом.
- Базовый gRPC сервер с запуском задач и чтением прогресса.
- Публичный пакет `pkg/cmrd` с программным запуском тех же сценариев.
- README + doc RU/EN с quick start и first run.
